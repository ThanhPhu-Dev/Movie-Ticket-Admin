<!DOCTYPE html>

<!--  main-fragment (title, otherStaticResources, header, nav, mainContent, footer)  -->
<html th:replace="~{layouts/main-layout :: main-fragment(
                                                ~{::title},
                                                ~{:: #home-static-resources},
                                                ~{:: #home-main-content}
                                               )}"
      xmlns:th="http://www.thymeleaf.org">
<title>Movie</title>
<th:block id="home-static-resources">

    <link rel="stylesheet" th:href="@{/css/admin/listMovieStyle.css}" type="text/css"/>

</th:block>

<div id="home-main-content">
    <div class="link-ref shadow mt-3">
        <span>Quản Lý Diễn Viên/</span> <a th:href="@{/listMovie}">Danh Sách Phim</a>
    </div>
    <div class="shadow movie_content">
        <form class="form-inline d-flex justify-content-center md-form form-sm active-cyan-2 mt-2" id="form-submit">
            <div style="width: 80%; display: flex; align-items: center">
                <input aria-label="Search" class="form-control form-control-sm" id="search-name"
                       placeholder="Search" style="width: 80%" type="text">
                <div style=" width: 10%; display: flex">
                    <i class="fas fa-times mr-2" id="icon-deleteAll-text" style="display: none; "></i>
                    <i aria-hidden="true" class="fas fa-search" style="color: cyan; "></i>
                </div>
            </div>
            <div>
                <select class="form-select" id="category">
                    <option selected value="0">Tất Cả</option>
                    <th:block th:each="cate : ${lstCategory}">
                        <option th:text="${cate.name}" th:value="${cate.id}">One</option>
                    </th:block>
                </select>
            </div>
        </form>
        <div id="list-movie">
            <th:block th:each="movie : ${listMovie}">
                <div class="movie-info d-inline-block ml-3 mr-2 mb-1 mt-2" th:object="${movie}">
                    <a th:href="@{/movie/{id}(id = *{id})}">
                        <div class="movie-info--img">
                            <img style="height: auto" th:src="*{posterUrl}" width="200">
                        </div>
                        <p th:text="*{name}"></p>
                    </a>
                </div>
            </th:block>
        </div>
        <div class="pagination mt-4" id="pagination">
            <a th:class="${currentPage >  1 ? '' : 'disabled'}" th:href="@{'/listMovie/page/' + ${currentPage - 1 }}">Last</a>
            <th:block th:each="i: ${#numbers.sequence(1, totalPages)}">
                <a th:class="'page-link ' + ${currentPage == i ? 'active disabled ' : ''}"
                   th:href="@{'/listMovie/page/' + ${i}}"
                >[[${i}]]</a>
            </th:block>
            <a th:class="${currentPage < totalPages ? '' : 'disabled'}"
               th:href="@{'/listMovie/page/' + ${currentPage + 1}}">Next</a>
        </div>
    </div>

    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script>
        let input = document.getElementById("search-name");
        let all_delete_text = document.getElementById("icon-deleteAll-text");
        const btnSubmit = document.getElementById("form-submit");
        let category = document.getElementById("category");


        input.addEventListener("input", (e) => {
            if (e.target.value.length == 0) {
                all_delete_text.style.display = "none"
                findByName("");
            } else {
                all_delete_text.style.display = "block"
            }
        })

        btnSubmit.addEventListener("submit", e => {
            e.preventDefault();
            findByName(input.value)
        })

        all_delete_text.addEventListener("click", e => {
            input.value = '';
            all_delete_text.style.display = "none"
            findByName("");
        })

        category.addEventListener("change", async e => {
            let divContent = document.getElementById("list-movie");
            let idCategory = e.target.value;
            let url = '/api/category-movie/' + idCategory;
            console.log(url)
            axios.get(url).then(function (response) {
                let content = response.data.map(element => {
                    return ` <div class="movie-info d-inline-block ml-3 mr-2 mb-1 mt-2">
                    <a href="/movie/${element.id}">
                        <div class="movie-info--img">
                            <img  src="${element.posterUrl}" width="200" style="height: auto">
                        </div>
                        <p>${element.name}</p>
                    </a>
                </div>`
                });

                divContent.innerHTML = content.join('');
            }).catch(function (error) {
                console.log(error)
            })
        })

        async function findByName(name) {
            let idCategory = category.value;
            let url = "/api/movie/" + idCategory + "/" + name;
            if (name == '') {
                url = "/api/movie/" + idCategory;
            }
            axios.get(url).then(function (response) {
                let data = response.data;
                renderDataSearch(data);
            }).catch(function (error) {
                console.log(error)
            })
        }

        function renderDataSearch(data){
            let divContent = document.getElementById("list-movie");
            let paging = document.getElementById("pagination");

            let content = data.content.map(element => {
                return ` <div class="movie-info d-inline-block ml-3 mr-2 mb-1 mt-2">
                    <a href="/movie/${element.id}">
                        <div class="movie-info--img">
                            <img  src="${element.posterUrl}" width="200" style="height: auto">
                        </div>
                        <p>${element.name}</p>
                    </a>
                </div>`
            });
            divContent.innerHTML = content.join('');

            /*paginated*/
            let btn_last = `<a class="${data.currentPage > 1 ? '' : 'disabled'}" onclick="nextprev(${data.currentPage - 1})" href="#">Last</a>`;
            let itempage = '';
            for (let i = 1; i < data.totalPages; i++) {
                itempage += `<a class="page-link ${data.currentPage == i ? 'active disabled ' : ''}"
                                   href="/listMovie/page/${i}"
                                >${i}</a>
                                 `;
            }
            let btn_next = `<a class="${data.currentPage < data.totalPages ? '' : 'disabled'}" onclick="nextprev(${data.currentPage + 1})"
                                    href="#">Next</a>`;
            paging.innerHTML = '';
            if(data.totalPages > 1){
                paging.innerHTML =btn_last;
                paging.insertAdjacentHTML("beforeend", itempage);
                paging.insertAdjacentHTML("beforeend", btn_next);
            }
        }

        function nextprev(currentPage){
            alert(currentPage);
        }
    </script>
</div>
